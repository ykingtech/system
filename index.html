<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass { background: #ffffff; border: 1px solid #e5e7eb; }
        .shadow-custom { box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; ring-color: #3b82f6; }
        .key:active { background: #2563eb; color: white; transform: scale(0.95); }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div id="loginScreen" class="fixed inset-0 z-[5000] bg-gray-100 flex items-center justify-center p-4">
    <div class="glass rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Login</h1>
        <p class="text-gray-500 mb-6">Enter PIN to access system</p>
        <div class="flex justify-center space-x-3 mb-6">
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot1"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot2"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot3"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot4"></div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-xl font-bold select-none mb-4">
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('1')">1</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('2')">2</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('3')">3</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('4')">4</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('5')">5</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('6')">6</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('7')">7</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('8')">8</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('9')">9</div>
            <div></div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('0')">0</div>
            <div class="key bg-red-500 text-white p-4 rounded-xl shadow cursor-pointer hover:bg-red-600" onclick="deleteKey()">‚å´</div>
        </div>
        <p id="errorMsg" class="text-red-600 hidden font-bold">Incorrect PIN!</p>
        <div class="mt-6 text-xs text-gray-400">Powered by <span class="font-semibold text-gray-500">The Kina Solutions</span></div>
    </div>
</div>

<div id="adminPinModal" class="fixed inset-0 z-[6000] bg-black/60 hidden items-center justify-center p-4">
    <div class="glass rounded-2xl shadow-2xl p-6 w-full max-w-xs text-center relative animate-[fadeIn_0.2s_ease-out]">
        <button onclick="closeAdminModal()" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        <h2 class="text-xl font-bold text-gray-800 mb-1">Admin Verification</h2>
        <p class="text-xs text-gray-500 mb-4" id="adminActionText">Enter PIN</p>
        <div class="flex justify-center space-x-2 mb-4">
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot1"></div>
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot2"></div>
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot3"></div>
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot4"></div>
        </div>
        <div class="grid grid-cols-3 gap-2 text-lg font-bold select-none">
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('1')">1</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('2')">2</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('3')">3</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('4')">4</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('5')">5</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('6')">6</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('7')">7</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('8')">8</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('9')">9</div>
            <div></div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('0')">0</div>
            <div class="key bg-red-100 text-red-600 p-3 rounded-lg shadow-sm cursor-pointer active:bg-red-200" onclick="deleteAdminKey()">‚å´</div>
        </div>
    </div>
</div>

<div id="mainSystem" class="min-h-screen flex flex-col" style="display: none;">
    <header class="glass border-b border-gray-200 sticky top-0 z-40 bg-white/90 backdrop-blur">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-xl">C</div>
                <h1 class="text-xl font-bold text-gray-800">Distribution System</h1>
            </div>
            <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-medium">Logout</button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 overflow-x-auto">
        <div class="glass rounded-xl p-2 inline-flex space-x-2 shadow-custom min-w-max bg-white">
            <button onclick="showTab('products')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="products">Products</button>
            <button onclick="showTab('distribution')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="distribution">Sales</button>
            <button onclick="showTab('returns')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="returns">Returns</button>
            <button onclick="showTab('restock')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="restock">Restock</button>
            <button onclick="showTab('ledger')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="ledger">Ledger</button>
            <button onclick="showTab('reports')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="reports">Reports</button>
        </div>
    </div>

    <div class="flex-grow">
        
        <div id="productsTab" class="container mx-auto px-4 pb-8 tab-content">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6" id="productFormTitle">Add New Product</h2>
                <input type="hidden" id="editingProductId">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <input type="text" id="prodName" placeholder="Product Name" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <input type="number" id="prodBuyPrice" placeholder="Buy Price" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <input type="number" id="prodSellPrice" placeholder="Sell Price" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <input type="number" id="prodStock" placeholder="Stock" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <button id="saveProductBtn" onclick="saveProduct()" class="bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition">Add</button>
                    <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-gray-500 text-white py-2 rounded-lg font-bold hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Stock List</h2>
                    <input type="text" id="productListSearch" placeholder="Search..." class="px-4 py-2 border rounded-lg focus:border-blue-500" onkeyup="updateUI()">
                </div>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-blue-600 text-white uppercase">
                            <tr><th class="px-4 py-3">Name</th><th class="px-4 py-3 text-right">Buy</th><th class="px-4 py-3 text-right">Sell</th><th class="px-4 py-3 text-right">Stock</th><th class="px-4 py-3 text-right">Value</th><th class="px-4 py-3 text-center">Action</th></tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="distributionTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">New Sale</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="relative lg:col-span-2">
                        <select id="distProduct" class="hidden"><option value="">Select</option></select>
                        <input type="text" id="distProductSearch" placeholder="Search Product..." class="w-full px-4 py-2 border rounded-lg focus:border-blue-500" onfocus="showDropdown('dist')" onblur="hideDropdown('dist', event)" onkeyup="filterProducts('dist')">
                        <div id="distProductDropdown" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="text" id="distShop" placeholder="Shop Name" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="distQty" placeholder="Sold Qty" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="distFreeQty" placeholder="Free Qty" class="px-4 py-2 border rounded-lg bg-yellow-50 focus:border-yellow-500">
                    
                    <div class="relative">
                        <label class="text-xs text-gray-500 block mb-1 font-bold">Buy Price (This Sale)</label>
                        <input type="number" id="distBuyPrice" placeholder="Auto" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700">
                    </div>
                    <div class="relative">
                        <label class="text-xs text-gray-500 block mb-1 font-bold">Sell Price (This Sale)</label>
                        <input type="number" id="distSellPrice" placeholder="Auto" class="w-full px-4 py-2 border border-blue-300 rounded-lg bg-white font-bold text-blue-800">
                    </div>

                    <button onclick="addDistribution()" class="bg-blue-600 text-white py-2 rounded-lg font-bold lg:col-span-4 hover:bg-blue-700 transition mt-2">Submit Sale</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <h2 class="text-xl font-bold mb-4">Recent Sales</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-blue-600 text-white uppercase">
                            <tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3">Shop</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Free</th><th class="p-3 text-right">Sold @</th><th class="p-3 text-right">Total</th></tr>
                        </thead>
                        <tbody id="distributionTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="returnsTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Return Items (Cart Mode)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <div class="relative lg:col-span-2">
                        <select id="retProduct" class="hidden"><option value="">Select</option></select>
                        <input type="text" id="retProductSearch" placeholder="Search Product..." class="w-full px-4 py-2 border rounded-lg focus:border-blue-500" onfocus="showDropdown('ret')" onblur="hideDropdown('ret', event)" onkeyup="filterProducts('ret')">
                        <div id="retProductDropdown" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="text" id="retShop" placeholder="Shop Name" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="retQty" placeholder="Sold Return Qty" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="retFreeQty" placeholder="Free Return Qty" class="px-4 py-2 border rounded-lg bg-yellow-50 focus:border-yellow-500">
                    
                    <select id="retReason" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                        <option value="Unsold">Unsold</option>
                        <option value="Expired">Expired</option>
                        <option value="Damaged">Damaged</option>
                    </select>

                    <div class="flex items-center gap-2 lg:col-span-6 bg-orange-50 p-2 rounded border border-orange-200">
                        <input type="checkbox" id="retAddToStock" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500" checked>
                        <label for="retAddToStock" class="text-sm font-bold text-orange-800 cursor-pointer">Add back to Stock?</label>
                    </div>

                    <button onclick="addToReturnCart()" class="bg-orange-500 text-white py-2 rounded-lg font-bold lg:col-span-6 hover:bg-orange-600 transition">Add to Return List</button>
                </div>
            </div>

            <div class="glass rounded-xl shadow-custom p-6 mb-6 border-2 border-orange-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-orange-800">Pending Return List</h3>
                    <button onclick="submitAllReturns()" id="submitReturnsBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 shadow hidden">Submit All Returns</button>
                </div>
                <div class="overflow-x-auto rounded-lg border bg-white">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-orange-100 text-orange-800 uppercase">
                            <tr><th class="p-3">Product</th><th class="p-3">Shop</th><th class="p-3">Reason</th><th class="p-3 text-right">Sold Ret</th><th class="p-3 text-right">Free Ret</th><th class="p-3 text-center">Action</th></tr>
                        </thead>
                        <tbody id="returnCartBody">
                            <tr><td colspan="6" class="p-4 text-center text-gray-400">List is empty</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="glass rounded-xl shadow-custom p-6">
                <h2 class="text-xl font-bold mb-4">Saved Returns History</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-orange-600 text-white uppercase">
                            <tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3">Shop</th><th class="p-3">Reason</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Free Ret</th><th class="p-3 text-right">Value (Deducted)</th></tr>
                        </thead>
                        <tbody id="returnsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="restockTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Restock Inventory</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <select id="restockProduct" class="hidden"><option value="">Select</option></select>
                        <input type="text" id="restockProductSearch" placeholder="Search Product..." class="w-full px-4 py-2 border rounded-lg focus:border-blue-500" onfocus="showDropdown('restock')" onblur="hideDropdown('restock', event)" onkeyup="filterProducts('restock')">
                        <div id="restockProductDropdown" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="number" id="restockQty" placeholder="Quantity" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <button onclick="addRestock()" class="bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700 transition">Restock</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <h2 class="text-xl font-bold mb-4">Recent Restocks</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-purple-600 text-white uppercase">
                            <tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Cost</th></tr>
                        </thead>
                        <tbody id="restockTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ledgerTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass p-4 rounded-xl mb-6 border border-blue-100 flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <input type="date" id="ledgerStart" class="border p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" onchange="filterLedger()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <input type="date" id="ledgerEnd" class="border p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" onchange="filterLedger()">
                </div>
                <button onclick="resetLedgerDates()" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Reset to This Month
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="glass p-4 rounded-xl bg-green-600 text-white shadow-lg">
                    <p class="text-sm opacity-80">Income (Selected Period)</p><p class="text-2xl font-bold" id="totalIncome">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-red-600 text-white shadow-lg">
                    <p class="text-sm opacity-80">Expenses (Selected Period)</p><p class="text-2xl font-bold" id="totalExpenses">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-orange-500 text-white shadow-lg">
                    <p class="text-sm opacity-80">Returns (Selected Period)</p><p class="text-2xl font-bold" id="totalReturnsVal">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-blue-700 text-white shadow-lg">
                    <p class="text-sm opacity-80">Net Profit (Selected Period)</p><p class="text-2xl font-bold" id="netProfit">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-gray-800 text-white shadow-lg">
                    <p class="text-sm opacity-80">Current Stock Value (Total)</p><p class="text-2xl font-bold" id="stockValue">Rs. 0.00</p>
                </div>
            </div>
            <div class="glass p-6 rounded-xl border border-gray-200">
                <h2 class="font-bold mb-4 text-gray-800 text-lg">Current Stock Overview</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-gray-800 text-white uppercase">
                            <tr><th class="p-3">Product</th><th class="p-3 text-right">Stock</th><th class="p-3 text-right">Cost Value</th></tr>
                        </thead>
                        <tbody id="stockValueTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reportsTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass p-6 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Generate Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="reportStartDate" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="reportEndDate" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h3 class="font-bold text-blue-800 mb-2">Financial Summary</h3>
                        <div class="flex flex-col gap-2">
                            <button onclick="generateFinancialReport('download')" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2"><span>üì•</span> Download PDF</button>
                            <button onclick="generateFinancialReport('print')" class="bg-white text-blue-600 border border-blue-600 py-2 px-4 rounded-lg font-bold hover:bg-blue-50 transition flex items-center justify-center gap-2"><span>üñ®Ô∏è</span> Print Report</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">Detailed Audit</h3>
                        <div class="flex flex-col gap-2">
                            <button onclick="generateAuditReport('download')" class="bg-gray-800 text-white py-2 px-4 rounded-lg font-bold hover:bg-gray-900 transition flex items-center justify-center gap-2"><span>üì•</span> Download PDF</button>
                            <button onclick="generateAuditReport('print')" class="bg-white text-gray-800 border border-gray-800 py-2 px-4 rounded-lg font-bold hover:bg-gray-50 transition flex items-center justify-center gap-2"><span>üñ®Ô∏è</span> Print Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <footer class="text-center py-6 text-gray-500 text-sm mt-auto bg-white border-t border-gray-200">
        Powered by <span class="font-semibold text-blue-600">The Kina Solutions</span>
    </footer>

</div>

<script>
    let pin = "1234", inputPin = "";
    function updateDots() { for(let i=1;i<=4;i++) document.getElementById("dot"+i).className = i<=inputPin.length ? "w-5 h-5 rounded-full bg-blue-600" : "w-5 h-5 rounded-full bg-gray-300"; }
    function pressKey(n) { if(inputPin.length<4) { inputPin+=n; updateDots(); if(inputPin.length===4) checkPin(); } }
    function deleteKey() { inputPin=inputPin.slice(0,-1); document.getElementById("errorMsg").classList.add("hidden"); updateDots(); }
    function checkPin() { if(inputPin===pin) { document.getElementById("loginScreen").style.display="none"; document.getElementById("mainSystem").style.display="flex"; showTab('products'); } else { document.getElementById("errorMsg").classList.remove("hidden"); inputPin=""; setTimeout(()=>{document.getElementById("errorMsg").classList.add("hidden"); updateDots();},1000); } }
    function logout() { document.getElementById("mainSystem").style.display="none"; document.getElementById("loginScreen").style.display="flex"; inputPin=""; updateDots(); }

    // Admin Modal Logic
    let adminPin = "", pendingAction = null, pendingTargetId = null;
    function openAdminModal(a,i) { pendingAction=a; pendingTargetId=i; adminPin=""; updateAdminDots(); document.getElementById("adminPinModal").classList.remove("hidden"); document.getElementById("adminPinModal").classList.add("flex"); }
    function closeAdminModal() { document.getElementById("adminPinModal").classList.add("hidden"); document.getElementById("adminPinModal").classList.remove("flex"); }
    function updateAdminDots() { for(let i=1;i<=4;i++) document.getElementById("adot"+i).className = i<=adminPin.length ? "w-4 h-4 rounded-full bg-blue-600" : "w-4 h-4 rounded-full bg-gray-300"; }
    function pressAdminKey(n) { if(adminPin.length<4) { adminPin+=n; updateAdminDots(); if(adminPin.length===4) checkAdminPin(); } }
    function deleteAdminKey() { adminPin=adminPin.slice(0,-1); updateAdminDots(); }
    function checkAdminPin() { if(adminPin===pin) { closeAdminModal(); if(pendingAction==='edit') editProductReal(pendingTargetId); if(pendingAction==='delete') deleteProductReal(pendingTargetId); } else { alert("Incorrect PIN!"); adminPin=""; updateAdminDots(); } }

    const firebaseApp = firebase.initializeApp({apiKey:"AIzaSyB_O5J7N3OocENr-De87sXAf5-ofpFtBLs",authDomain:"pos-app-37e46.firebaseapp.com",databaseURL:"https://pos-app-37e46-default-rtdb.firebaseio.com",projectId:"pos-app-37e46",storageBucket:"pos-app-37e46.firebasestorage.app",messagingSenderId:"110849552548",appId:"1:110849552548:web:fa95ce2f798ccdae8eb631"});
    const database = firebaseApp.database();
    
    let products=[], distributions=[], restocks=[], returns=[], returnCart=[];
    let currentTab = 'products';

    function writeData(path, data) { database.ref(path).set(data).catch(e=>console.error(e)); }
    function initializeDatabaseListeners() {
        database.ref('products').on('value', s => { products = s.val() ? Object.values(s.val()) : []; updateUI(); });
        database.ref('distributions').limitToLast(200).on('value', s => { distributions = s.val() ? Object.values(s.val()).sort((a,b)=>new Date(a.date)-new Date(b.date)) : []; if(currentTab==='distribution'||currentTab==='ledger') updateUI(); });
        database.ref('restocks').limitToLast(200).on('value', s => { restocks = s.val() ? Object.values(s.val()).sort((a,b)=>new Date(a.date)-new Date(b.date)) : []; if(currentTab==='restock'||currentTab==='ledger') updateUI(); });
        database.ref('returns').limitToLast(200).on('value', s => { returns = s.val() ? Object.values(s.val()).sort((a,b)=>new Date(a.date)-new Date(b.date)) : []; if(currentTab==='returns'||currentTab==='ledger') updateUI(); });
    }

    function showTab(tab) {
        currentTab = tab; document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(e=>{e.classList.remove('bg-blue-600','text-white'); e.classList.add('text-gray-600');});
        document.getElementById(tab+'Tab').classList.remove('hidden'); document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-blue-600','text-white');
        updateUI();
    }

    // --- Product Functions ---
    function saveProduct() {
        const id = document.getElementById('editingProductId').value || Date.now();
        const data = { id: parseInt(id), name: document.getElementById('prodName').value, buyPrice: parseFloat(document.getElementById('prodBuyPrice').value)||0, sellPrice: parseFloat(document.getElementById('prodSellPrice').value)||0, stock: parseFloat(document.getElementById('prodStock').value)||0 };
        if(!data.name) return alert("Name required");
        writeData(`products/${data.id}`, data); cancelEdit();
    }
    function editProduct(id) { openAdminModal('edit', id); }
    function editProductReal(id) {
        const p = products.find(x=>x.id===id);
        document.getElementById('editingProductId').value=p.id; document.getElementById('prodName').value=p.name; document.getElementById('prodBuyPrice').value=p.buyPrice; document.getElementById('prodSellPrice').value=p.sellPrice; document.getElementById('prodStock').value=p.stock;
        document.getElementById('productFormTitle').innerText="Edit Product"; document.getElementById('saveProductBtn').innerText="Update"; document.getElementById('cancelEditBtn').classList.remove('hidden'); document.getElementById('productsTab').scrollIntoView();
    }
    function cancelEdit() { document.getElementById('editingProductId').value=''; document.getElementById('prodName').value=''; document.getElementById('prodStock').value=''; document.getElementById('prodBuyPrice').value=''; document.getElementById('prodSellPrice').value=''; document.getElementById('productFormTitle').innerText="Add New Product"; document.getElementById('saveProductBtn').innerText="Add"; document.getElementById('cancelEditBtn').classList.add('hidden'); }
    function deleteProduct(id) { openAdminModal('delete', id); }
    function deleteProductReal(id) { if(confirm("Delete?")) writeData(`products/${id}`, null); }

    // --- Transaction Functions ---
    function addDistribution() {
        let pid = parseInt(document.getElementById('distProduct').value);
        
        // Auto-detect product from search input if ID missing
        if(!pid) {
            const searchText = document.getElementById('distProductSearch').value.toLowerCase();
            const pFound = products.find(p => p.name.toLowerCase() === searchText);
            if(pFound) pid = pFound.id;
        }

        const shop = document.getElementById('distShop').value;
        const qty = parseFloat(document.getElementById('distQty').value)||0;
        const free = parseFloat(document.getElementById('distFreeQty').value)||0;
        const cBuy = parseFloat(document.getElementById('distBuyPrice').value)||0;
        const cSell = parseFloat(document.getElementById('distSellPrice').value)||0;

        if(!pid) return alert("Please select a product from the list.");
        if(!shop) return alert("Shop name required");
        
        const p = products.find(x=>x.id===pid);
        if(p.stock < (qty+free)) return alert("Low Stock!");
        
        writeData(`products/${p.id}`, {...p, stock: p.stock-(qty+free)});
        const dist = { id: Date.now(), date: new Date().toISOString(), productName: p.name, shop, qty, freeQty: free, value: cSell*qty, buyPrice: cBuy, sellPrice: cSell };
        writeData(`distributions/${dist.id}`, dist);
        
        document.getElementById('distQty').value=''; document.getElementById('distFreeQty').value=''; document.getElementById('distShop').value=''; document.getElementById('distProduct').value=''; document.getElementById('distProductSearch').value='';
        document.getElementById('distBuyPrice').value=''; document.getElementById('distSellPrice').value='';
    }

    function addRestock() {
        const pid = parseInt(document.getElementById('restockProduct').value); const qty = parseFloat(document.getElementById('restockQty').value)||0;
        if(!pid || qty<=0) return alert("Invalid");
        const p = products.find(x=>x.id===pid);
        writeData(`products/${p.id}`, {...p, stock: p.stock+qty});
        writeData(`restocks/${Date.now()}`, { id: Date.now(), date: new Date().toISOString(), productName: p.name, qty, cost: p.buyPrice*qty });
        document.getElementById('restockQty').value=''; document.getElementById('restockProduct').value=''; document.getElementById('restockProductSearch').value='';
    }

    // --- RETURN CART SYSTEM ---
    function addToReturnCart() {
        let pid = parseInt(document.getElementById('retProduct').value);
        // Fix: Auto-detect product from search input
        if(!pid) {
            const searchText = document.getElementById('retProductSearch').value.toLowerCase();
            const pFound = products.find(p => p.name.toLowerCase() === searchText);
            if(pFound) pid = pFound.id;
        }

        const shop = document.getElementById('retShop').value;
        const qty = parseFloat(document.getElementById('retQty').value)||0;
        const free = parseFloat(document.getElementById('retFreeQty').value)||0;
        const reason = document.getElementById('retReason').value;
        const addStock = document.getElementById('retAddToStock').checked;

        if(!pid) return alert("Product not selected. Click product from list.");
        if(!shop) return alert("Enter shop name.");
        if((qty+free)<=0) return alert("Enter quantity.");

        const p = products.find(x=>x.id===pid);
        returnCart.push({ pid, name: p.name, shop, qty, free, reason, addStock, sellPrice: p.sellPrice });
        renderReturnCart();
        
        document.getElementById('retQty').value=''; document.getElementById('retFreeQty').value='';
        document.getElementById('retProduct').value=''; document.getElementById('retProductSearch').value='';
    }

    function renderReturnCart() {
        const tbody = document.getElementById('returnCartBody');
        const btn = document.getElementById('submitReturnsBtn');
        if(returnCart.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">List is empty</td></tr>';
            btn.classList.add('hidden');
        } else {
            btn.classList.remove('hidden');
            tbody.innerHTML = returnCart.map((item, index) => `
                <tr class="border-b hover:bg-orange-50">
                    <td class="p-2 font-medium">${item.name}</td>
                    <td class="p-2 text-xs text-gray-600">${item.shop}</td>
                    <td class="p-2 text-xs text-gray-600">${item.reason}</td>
                    <td class="p-2 text-right font-bold">${item.qty}</td>
                    <td class="p-2 text-right text-orange-600 font-bold">${item.free}</td>
                    <td class="p-2 text-center"><button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg">√ó</button></td>
                </tr>
            `).join('');
        }
    }

    function removeFromCart(index) { returnCart.splice(index, 1); renderReturnCart(); }

    function submitAllReturns() {
        if(!confirm("Submit all pending returns?")) return;
        returnCart.forEach(item => {
            const p = products.find(x=>x.id === item.pid);
            if(item.addStock) writeData(`products/${p.id}`, {...p, stock: p.stock + item.qty + item.free});
            const retData = { id: Date.now() + Math.random(), date: new Date().toISOString(), productName: item.name, shop: item.shop, qty: item.qty, freeQty: item.free, reason: item.reason, addedToStock: item.addStock, value: item.sellPrice * item.qty };
            writeData(`returns/${Math.floor(retData.id * 1000)}`, retData);
        });
        returnCart = []; renderReturnCart(); document.getElementById('retShop').value = ''; alert("Returns Submitted!");
    }

    // --- UI Helpers ---
    function showDropdown(t) { document.getElementById(t+'ProductDropdown').classList.remove('hidden'); filterProducts(t); }
    function hideDropdown(t, e) { setTimeout(()=>{ if(!e.relatedTarget?.closest('#'+t+'ProductDropdown')) document.getElementById(t+'ProductDropdown').classList.add('hidden'); }, 200); }
    
    function filterProducts(t) {
        const val = document.getElementById(t+'ProductSearch').value.toLowerCase();
        const list = products.filter(p=>p.name.toLowerCase().includes(val));
        const div = document.getElementById(t+'ProductDropdown');
        div.innerHTML = list.length ? list.map(p=>`<div class="p-2 hover:bg-blue-50 cursor-pointer border-b" onclick="selectProduct('${t}',${p.id},'${p.name.replace(/'/g,"\\'")}')">${p.name} (${p.stock})</div>`).join('') : '<div class="p-2 text-gray-500">No items</div>';
    }
    
    function selectProduct(t, id, name) {
        document.getElementById(t+'Product').value = id;
        document.getElementById(t+'ProductSearch').value = name;
        document.getElementById(t+'ProductDropdown').classList.add('hidden');
        if(t === 'dist') {
            const p = products.find(x=>x.id===id);
            document.getElementById('distBuyPrice').value = p.buyPrice;
            document.getElementById('distSellPrice').value = p.sellPrice;
        }
    }

    function initLedgerDates() {
        const d = new Date(), f = new Date(d.getFullYear(), d.getMonth(), 1), l = new Date(d.getFullYear(), d.getMonth() + 1, 0);
        const fmt = d => d.toISOString().split('T')[0];
        document.getElementById('ledgerStart').value = fmt(f); document.getElementById('ledgerEnd').value = fmt(l);
    }
    function filterLedger() { updateUI(); }
    function resetLedgerDates() { initLedgerDates(); updateUI(); }

    function updateUI() {
        if(currentTab==='products') {
            const tbody = document.getElementById('productsTableBody');
            const search = document.getElementById('productListSearch').value.toLowerCase();
            tbody.innerHTML = products.filter(p=>p.name.toLowerCase().includes(search)).map(p=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-right">${p.buyPrice}</td><td class="p-3 text-right">${p.sellPrice}</td><td class="p-3 text-right font-bold">${p.stock}</td><td class="p-3 text-right">${(p.buyPrice*p.stock).toFixed(2)}</td><td class="p-3 text-center"><button onclick="editProduct(${p.id})" class="text-blue-600 mr-2">Edit</button><button onclick="deleteProduct(${p.id})" class="text-red-500">Del</button></td></tr>`).join('');
        }
        if(currentTab==='distribution') {
            const tbody = document.getElementById('distributionTableBody');
            tbody.innerHTML = distributions.slice().reverse().map(d=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3">${new Date(d.date).toLocaleDateString()}</td><td class="p-3 font-medium">${d.productName}</td><td class="p-3 text-gray-500">${d.shop}</td><td class="p-3 text-right">${d.qty}</td><td class="p-3 text-right text-orange-600">${d.freeQty||0}</td><td class="p-3 text-right text-xs text-gray-400">${d.sellPrice}</td><td class="p-3 text-right font-bold text-green-600">${d.value.toFixed(2)}</td></tr>`).join('');
        }
        if(currentTab==='restock') {
            const tbody = document.getElementById('restockTableBody');
            tbody.innerHTML = restocks.slice().reverse().map(r=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3">${new Date(r.date).toLocaleDateString()}</td><td class="p-3 font-medium">${r.productName}</td><td class="p-3 text-right font-bold">${r.qty}</td><td class="p-3 text-right text-red-600">${r.cost.toFixed(2)}</td></tr>`).join('');
        }
        if(currentTab==='returns') {
            const tbody = document.getElementById('returnsTableBody');
            tbody.innerHTML = returns.slice().reverse().map(r=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3">${new Date(r.date).toLocaleDateString()}</td><td class="p-3 font-medium">${r.productName}</td><td class="p-3 text-gray-500">${r.shop}</td><td class="p-3 text-xs">${r.reason}</td><td class="p-3 text-right font-bold">${r.qty}</td><td class="p-3 text-right text-orange-600 font-bold">${r.freeQty||0}</td><td class="p-3 text-right text-red-500">-${r.value.toFixed(2)}</td></tr>`).join('');
        }
        if(currentTab==='ledger') {
            const s = new Date(document.getElementById('ledgerStart').value), e = new Date(document.getElementById('ledgerEnd').value); e.setHours(23,59,59);
            const fd = distributions.filter(d=>new Date(d.date)>=s && new Date(d.date)<=e);
            const fr = restocks.filter(r=>new Date(r.date)>=s && new Date(r.date)<=e);
            const fre = returns.filter(r=>new Date(r.date)>=s && new Date(r.date)<=e);
            
            const inc = fd.reduce((a,b)=>a+b.value,0);
            const exp = fr.reduce((a,b)=>a+b.cost,0);
            const ret = fre.reduce((a,b)=>a+b.value,0);
            
            document.getElementById('totalIncome').innerText = "Rs. "+inc.toFixed(2);
            document.getElementById('totalExpenses').innerText = "Rs. "+exp.toFixed(2);
            document.getElementById('totalReturnsVal').innerText = "Rs. "+ret.toFixed(2);
            document.getElementById('netProfit').innerText = "Rs. "+(inc-exp-ret).toFixed(2);
            document.getElementById('stockValue').innerText = "Rs. "+products.reduce((a,b)=>a+(b.buyPrice*b.stock),0).toFixed(2);
            
            document.getElementById('stockValueTableBody').innerHTML = products.map(p=>`<tr class="border-b"><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-right">${p.stock}</td><td class="p-3 text-right">${(p.buyPrice*p.stock).toFixed(2)}</td></tr>`).join('');
        }
        
        const types = ['dist', 'restock', 'ret'];
        types.forEach(t => { if(!document.getElementById(t+'ProductSearch')?.value) document.getElementById(t+'Product').value = ""; });
    }

    // --- REPORTS (Black & White Printer Friendly) ---
    function generateFinancialReport(mode='download') {
        const s = document.getElementById('reportStartDate').value, e = document.getElementById('reportEndDate').value;
        if(!s||!e) return alert("Select Dates");
        const sd=new Date(s), ed=new Date(e); ed.setHours(23,59,59);
        
        const fd = distributions.filter(d=>new Date(d.date)>=sd && new Date(d.date)<=ed);
        const fr = restocks.filter(r=>new Date(r.date)>=sd && new Date(r.date)<=ed);
        const fre = returns.filter(r=>new Date(r.date)>=sd && new Date(r.date)<=ed);
        
        const doc = new window.jspdf.jsPDF();
        doc.setDrawColor(0); doc.setTextColor(0);
        
        doc.setFontSize(16); doc.text("Distribution Agency Financial Report", 105, 15, {align:"center"});
        doc.setFontSize(10); doc.text(`Period: ${s} - ${e}`, 105, 22, {align:"center"});
        
        const inc = fd.reduce((a,b)=>a+b.value,0);
        const exp = fr.reduce((a,b)=>a+b.cost,0);
        const ret = fre.reduce((a,b)=>a+b.value,0);
        const stv = products.reduce((a,b)=>a+(b.buyPrice*b.stock),0);
        
        // 1. Summary
        doc.setFontSize(12); doc.setFont("helvetica", "bold");
        doc.text("1. Financial Summary", 14, 35);
        doc.autoTable({
            startY: 40,
            head: [['Metric','Value']],
            body: [
                ['Total Sales Income',`Rs. ${inc.toFixed(2)}`],
                ['Total Restock Cost (Expenses)',`Rs. ${exp.toFixed(2)}`],
                ['Net Profit/Loss',`Rs. ${(inc-exp-ret).toFixed(2)}`],
                ['Current Stock Value (at Cost)',`Rs. ${stv.toFixed(2)}`]
            ],
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        // 2. Sales
        let y = doc.lastAutoTable.finalY+10;
        doc.text("2. Distribution (Sales) Details",14,y);
        doc.autoTable({
            startY:y+5,
            head:[['Date','Product','Shop','Qty','Free','Val']],
            body:fd.map(d=>[new Date(d.date).toLocaleDateString(),d.productName,d.shop,d.qty,d.freeQty,d.value.toFixed(2)]),
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        // 3. Returns
        y = doc.lastAutoTable.finalY+10;
        if(y>260){doc.addPage();y=20;}
        doc.text("3. Returns (Deductions) Details",14,y);
        doc.autoTable({
            startY:y+5,
            head:[['Date','Product','Shop','Reason','Sold Ret','Free Ret','Val']],
            body:fre.map(r=>[new Date(r.date).toLocaleDateString(),r.productName,r.shop,r.reason,r.qty,r.freeQty||0,r.value.toFixed(2)]),
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        // 4. Restock
        y = doc.lastAutoTable.finalY+10;
        if(y>260){doc.addPage();y=20;}
        doc.text("4. Restock (Expense) Details",14,y);
        doc.autoTable({
            startY:y+5,
            head:[['Date','Product','Qty','Cost']],
            body:fr.map(r=>[new Date(r.date).toLocaleDateString(),r.productName,r.qty,r.cost.toFixed(2)]),
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        if(mode==='print') { doc.autoPrint(); window.open(doc.output('bloburl'), '_blank'); } else { doc.save(`Report_${s}_${e}.pdf`); }
    }

    function generateAuditReport(mode) { 
        const s = document.getElementById('reportStartDate').value, e = document.getElementById('reportEndDate').value;
        if(!s||!e) return alert("Select Dates");
        const sd=new Date(s), ed=new Date(e); ed.setHours(23,59,59);
        
        const fd = distributions.filter(d=>new Date(d.date)>=sd && new Date(d.date)<=ed);
        const fre = returns.filter(r=>new Date(r.date)>=sd && new Date(r.date)<=ed);
        
        const doc = new window.jspdf.jsPDF('l'); 
        doc.setDrawColor(0); doc.setTextColor(0);
        
        doc.setFontSize(16); doc.text("Detailed Audit Report", 14, 15);
        doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);
        
        let y=35;
        doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("1. Current Stock Status", 14, y);
        doc.autoTable({
            startY: y+5,
            head:[['ID','Name','Buy','Sell','Stock','Value']], 
            body:[...products.map(p=>[p.id,p.name,p.buyPrice,p.sellPrice,p.stock,(p.buyPrice*p.stock).toFixed(2)]),['','','','','Total:',products.reduce((a,b)=>a+(b.buyPrice*b.stock),0).toFixed(2)]],
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        y = doc.lastAutoTable.finalY + 10;
        doc.text("2. Sales Transactions", 14, y);
        const saleTot = fd.reduce((a,b)=>a+b.value,0);
        doc.autoTable({
            startY:y+5, 
            head:[['Date','Item','Shop','Qty','Free','Value']], 
            body:[...fd.map(d=>[new Date(d.date).toLocaleDateString(),d.productName,d.shop,d.qty,d.freeQty,d.value.toFixed(2)]),['','','','','Total:',saleTot.toFixed(2)]],
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        y = doc.lastAutoTable.finalY + 10;
        if(y>180){doc.addPage();y=20;}
        doc.text("3. Returns (Deductions)", 14, y);
        const retTot = fre.reduce((a,b)=>a+b.value,0);
        doc.autoTable({
            startY:y+5, 
            head:[['Date','Item','Shop','Reason','Stock Added?','Qty','Value']], 
            body:[...fre.map(r=>[new Date(r.date).toLocaleDateString(),r.productName,r.shop,r.reason,r.addedToStock?'Yes':'No',r.qty,r.value.toFixed(2)]),['','','','','','Total:',retTot.toFixed(2)]],
            theme: 'grid',
            styles: { textColor: 0, lineColor: 0, lineWidth: 0.1 },
            headStyles: { fillColor: 255, textColor: 0, fontStyle: 'bold' }
        });
        
        y = doc.lastAutoTable.finalY + 15;
        doc.setFontSize(14); 
        doc.text(`Net Period Profit: Rs. ${(saleTot - retTot).toFixed(2)}`, 14, y);

        if(mode==='print') { doc.autoPrint(); window.open(doc.output('bloburl'), '_blank'); } else { doc.save("detailed_audit_report.pdf"); }
    }

    const d = new Date(); document.getElementById('reportEndDate').valueAsDate = d; d.setDate(d.getDate()-30); document.getElementById('reportStartDate').valueAsDate = d;
    initLedgerDates(); updateDots(); initializeDatabaseListeners();
</script>
</body>
</html>

