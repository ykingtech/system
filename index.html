<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution Agency Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* වේගය වැඩි කිරීමට වෙනස් කළ කොටස (No Blur, Solid Color) */
        .glass { 
            background: #ffffff; 
            border: 1px solid #e5e7eb; /* Blur වෙනුවට පාටක් සහ ඉරක් */
        }
        
        /* Shadows අඩු කළා */
        .shadow-custom { box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; ring-color: #3b82f6; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* PIN Login Styles */
        .key:hover { background: #2563eb; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

<div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 fade-in">
    <div class="glass rounded-2xl shadow-custom p-8 w-full max-w-sm text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Enter PIN</h1>
        <p class="text-gray-500 mb-6">Access your system</p>

        <div class="flex justify-center space-x-3 mb-6">
            <div class="w-5 h-5 bg-gray-300 rounded-full" id="dot1"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full" id="dot2"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full" id="dot3"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full" id="dot4"></div>
        </div>

        <div class="grid grid-cols-3 gap-4 text-xl font-bold select-none mb-4">
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('1')">1</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('2')">2</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('3')">3</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('4')">4</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('5')">5</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('6')">6</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('7')">7</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('8')">8</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('9')">9</div>
            <div></div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer" onclick="pressKey('0')">0</div>
            <div class="key bg-red-500 text-white p-4 rounded-xl shadow cursor-pointer" onclick="deleteKey()">⌫</div>
        </div>

        <p id="errorMsg" class="text-red-600 hidden">Incorrect PIN!</p>
    </div>
</div>

<div id="mainSystem" class="hidden">

<header class="glass border-b border-gray-200 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Distribution Agency System</h1>
            </div>
            <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Logout</button>
        </div>
    </div>
</header>

<div class="container mx-auto px-4 py-6">
    <div class="glass rounded-xl p-2 inline-flex space-x-2 shadow-custom">
        <button onclick="showTab('products')" class="tab-btn px-6 py-2 rounded-lg font-medium transition" data-tab="products">Products</button>
        <button onclick="showTab('distribution')" class="tab-btn px-6 py-2 rounded-lg font-medium transition" data-tab="distribution">Distribution</button>
        <button onclick="showTab('restock')" class="tab-btn px-6 py-2 rounded-lg font-medium transition" data-tab="restock">Restock</button>
        <button onclick="showTab('ledger')" class="tab-btn px-6 py-2 rounded-lg font-medium transition" data-tab="ledger">Ledger</button>
        <button onclick="showTab('reports')" class="tab-btn px-6 py-2 rounded-lg font-medium transition" data-tab="reports">Reports</button>
    </div>
</div>

<div id="productsTab" class="container mx-auto px-4 pb-8 tab-content">
    <div class="glass rounded-xl shadow-custom p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Add New Product</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <input type="text" id="prodName" placeholder="Product Name" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            <input type="number" id="prodBuyPrice" placeholder="Buy Price" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            <input type="number" id="prodSellPrice" placeholder="Sell Price" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            <input type="number" id="prodStock" placeholder="Initial Stock" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            
            <button onclick="addProduct()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white py-2 rounded-lg font-semibold hover:from-green-600 hover:to-emerald-600 transition">Add Product</button>
        </div>
    </div>

    <div class="glass rounded-xl shadow-custom p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Product List</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left rounded-tl-lg">Product</th>
                        <th class="px-4 py-3 text-right">Buy Price</th>
                        <th class="px-4 py-3 text-right">Sell Price</th>
                        <th class="px-4 py-3 text-right">Stock</th>
                        <th class="px-4 py-3 text-right">Stock Value (Cost)</th>
                        <th class="px-4 py-3 text-center rounded-tr-lg">Action</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="distributionTab" class="container mx-auto px-4 pb-8 tab-content hidden">
    <div class="glass rounded-xl shadow-custom p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Distribute to Shops</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div class="relative lg:col-span-2">
                <select id="distProduct" class="hidden">
                    <option value="">Select Product</option>
                </select>
                
                <input type="text" id="distProductSearch" placeholder="Select or Search Product..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg cursor-pointer"
                       autocomplete="off"
                       onfocus="showDropdown('dist')" onblur="hideDropdown('dist', event)"
                       onkeyup="filterProducts('dist')">

                <div id="distProductDropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                    </div>
            </div>
            <input type="text" id="distShop" placeholder="Shop Name" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            
            <input type="number" id="distQty" placeholder="Sold Qty" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            
            <input type="number" id="distFreeQty" placeholder="Free Qty" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg bg-yellow-50">

            <button onclick="addDistribution()" class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white py-2 rounded-lg font-semibold hover:from-blue-600 hover:to-indigo-600 transition lg:col-span-5 md:col-span-2">Distribute Items</button>
        </div>
    </div>

    <div class="glass rounded-xl shadow-custom p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Distribution History</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left rounded-tl-lg">Date</th>
                        <th class="px-4 py-3 text-left">Product</th>
                        <th class="px-4 py-3 text-left">Shop</th>
                        <th class="px-4 py-3 text-right">Sold Qty</th>
                        <th class="px-4 py-3 text-right bg-yellow-500 bg-opacity-20">Free Qty</th>
                        <th class="px-4 py-3 text-right rounded-tr-lg">Value (Income)</th>
                    </tr>
                </thead>
                <tbody id="distributionTableBody" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="restockTab" class="container mx-auto px-4 pb-8 tab-content hidden">
    <div class="glass rounded-xl shadow-custom p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Restock Inventory</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="relative">
                <select id="restockProduct" class="hidden">
                    <option value="">Select Product</option>
                </select>
                
                <input type="text" id="restockProductSearch" placeholder="Select or Search Product..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg cursor-pointer"
                       autocomplete="off"
                       onfocus="showDropdown('restock')" onblur="hideDropdown('restock', event)"
                       onkeyup="filterProducts('restock')">

                <div id="restockProductDropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                    </div>
            </div>
            <input type="number" id="restockQty" placeholder="Quantity" autocomplete="off" class="px-4 py-2 border border-gray-300 rounded-lg">
            <button onclick="addRestock()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 transition">Restock</button>
        </div>
    </div>

    <div class="glass rounded-xl shadow-custom p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Restock History</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left rounded-tl-lg">Date</th>
                        <th class="px-4 py-3 text-left">Product</th>
                        <th class="px-4 py-3 text-right">Quantity</th>
                        <th class="px-4 py-3 text-right rounded-tr-lg">Cost (Expense)</th>
                    </tr>
                </thead>
                <tbody id="restockTableBody" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="ledgerTab" class="container mx-auto px-4 pb-8 tab-content hidden">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="glass rounded-xl shadow-custom p-6 bg-gradient-to-br from-green-500 to-emerald-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white text-sm font-medium mb-1">Total Income</p>
                    <p class="text-white text-3xl font-bold" id="totalIncome">Rs. 0.00</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="glass rounded-xl shadow-custom p-6 bg-gradient-to-br from-red-500 to-pink-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white text-sm font-medium mb-1">Total Expenses</p>
                    <p class="text-white text-3xl font-bold" id="totalExpenses">Rs. 0.00</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="glass rounded-xl shadow-custom p-6 bg-gradient-to-br from-blue-500 to-indigo-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white text-sm font-medium mb-1">Stock Value (Cost)</p>
                    <p class="text-white text-3xl font-bold" id="stockValue">Rs. 0.00</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <div class="glass rounded-xl shadow-custom p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Stock Value by Product</h2>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-left rounded-tl-lg">Product</th>
                        <th class="px-4 py-3 text-right">Stock</th>
                        <th class="px-4 py-3 text-right">Buy Price</th>
                        <th class="px-4 py-3 text-right rounded-tr-lg">Total Value (Cost)</th>
                    </tr>
                </thead>
                <tbody id="stockValueTableBody" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="reportsTab" class="container mx-auto px-4 pb-8 tab-content hidden">
    <div class="glass rounded-xl shadow-custom p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Generate Reports (Date Range)</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="date" id="reportStartDate" class="px-4 py-2 border border-gray-300 rounded-lg">
            <input type="date" id="reportEndDate" class="px-4 py-2 border border-gray-300 rounded-lg">
            <button onclick="generateReport()" class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-2 rounded-lg font-semibold hover:from-indigo-600 hover:to-purple-600 transition">Download PDF Report</button>
        </div>
    </div>

    <div class="glass rounded-xl shadow-custom p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Daily History Viewer</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <input type="date" id="dailyHistoryDate" class="px-4 py-2 border border-gray-300 rounded-lg md:col-span-1">
            <button onclick="viewDailyHistory()" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white py-2 rounded-lg font-semibold hover:from-teal-600 hover:to-cyan-600 transition md:col-span-2">View History for Selected Date</button>
        </div>
        <div id="dailyHistoryResults" class="space-y-4">
            <p class="text-gray-500">Select a date above to view transactions.</p>
        </div>
    </div>
</div>

</div> <script>
    /* ================= PIN LOGIN LOGIC ================= */
    let pin = "1234"; // Set your default PIN here
    let inputPin = "";

    function updateDots() {
        for (let i = 1; i <= 4; i++) {
            const dot = document.getElementById("dot" + i);
            dot.classList.remove("bg-gray-300", "bg-blue-600");
            dot.classList.add(i <= inputPin.length ? "bg-blue-600" : "bg-gray-300");
        }
    }

    function pressKey(n) {
        if (inputPin.length >= 4) return;
        inputPin += n;
        updateDots();

        if (inputPin.length === 4) {
            if (inputPin === pin) {
                document.getElementById("errorMsg").classList.add("hidden");
                // Successful Login: Load System and Firebase
                document.getElementById("loginScreen").classList.add("hidden");
                document.getElementById("mainSystem").classList.remove("hidden");
                
                // *** FIREBASE INITIALIZATION ON SUCCESSFUL LOGIN ***
                initializeDatabaseListeners();
                showTab('products');
                
            } else {
                // Incorrect PIN
                document.getElementById("errorMsg").classList.remove("hidden");
                inputPin = "";
                // Flash dots red for error
                for (let i = 1; i <= 4; i++) document.getElementById("dot" + i).classList.add("bg-red-500");
                
                setTimeout(() => {
                    document.getElementById("errorMsg").classList.add("hidden");
                    for (let i = 1; i <= 4; i++) document.getElementById("dot" + i).classList.remove("bg-red-500");
                    updateDots();
                }, 1000);
            }
        }
    }

    function deleteKey() {
        inputPin = inputPin.slice(0, -1);
        document.getElementById("errorMsg").classList.add("hidden");
        updateDots();
    }
    
    /* ================= ORIGINAL FULL JAVASCRIPT (WITH FIREBASE) ================= */

    // Firebase Functions (Compat libraries used for simple setup)
    const firebaseApp = firebase.initializeApp({
        apiKey: "AIzaSyB_O5J7N3OocENr-De87sXAf5-ofpFtBLs",
        authDomain: "pos-app-37e46.firebaseapp.com",
        databaseURL: "https://pos-app-37e46-default-rtdb.firebaseio.com",
        projectId: "pos-app-37e46",
        storageBucket: "pos-app-37e46.firebasestorage.app",
        messagingSenderId: "110849552548",
        appId: "1:110849552548:web:fa95ce2f798ccdae8eb631",
        measurementId: "G-QQMSQV4ESB"
    });

    // Initialize Realtime Database
    const database = firebaseApp.database();
    // Removed defaultPassword, now using 'pin'
    let products = [];
    let distributions = [];
    let restocks = [];
    let currentTab = 'products';

    // --- Firebase Data Handling ---

    function writeData(path, data) {
        database.ref(path).set(data)
            .then(() => console.log(`${path} updated successfully.`))
            .catch(error => console.error(`Error updating ${path}:`, error));
    }

    function initializeDatabaseListeners() {
        // Listen for Products changes
        database.ref('products').on('value', (snapshot) => {
            const data = snapshot.val();
            products = data ? Object.values(data) : [];
            console.log("Products loaded from Firebase.");
            updateUI();
        });

        // Listen for Distributions changes
        database.ref('distributions').on('value', (snapshot) => {
            const data = snapshot.val();
            distributions = data ? Object.values(data).sort((a, b) => new Date(a.date) - new Date(b.date)) : [];
            console.log("Distributions loaded from Firebase.");
            if (currentTab === 'distribution') updateUI();
        });

        // Listen for Restocks changes
        database.ref('restocks').on('value', (snapshot) => {
            const data = snapshot.val();
            restocks = data ? Object.values(data).sort((a, b) => new Date(a.date) - new Date(b.date)) : [];
            console.log("Restocks loaded from Firebase.");
            if (currentTab === 'restock') updateUI();
        });
    }

    // --- Core Functions adapted for Firebase ---
    
    function logout() {
        // Hides system and shows PIN login screen
        document.getElementById('mainSystem').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        inputPin = ""; // Clear pin input
        updateDots(); // Reset dots
    }

    function showTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white');
            el.classList.add('text-gray-600', 'hover:bg-gray-100');
        });
        
        document.getElementById(tabName + 'Tab').classList.remove('hidden');
        const btn = document.querySelector(`[data-tab="${tabName}"]`);
        btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-indigo-600', 'text-white');
        btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
        
        updateUI();
    }

    function addProduct() {
        const name = document.getElementById('prodName').value.trim();
        const buyPrice = parseFloat(document.getElementById('prodBuyPrice').value) || 0;
        const sellPrice = parseFloat(document.getElementById('prodSellPrice').value) || 0;
        const stock = parseFloat(document.getElementById('prodStock').value) || 0;

        if (!name || buyPrice <= 0 || sellPrice <= 0 || stock < 0) {
            alert('Please enter all details correctly!');
            return;
        }

        const newProduct = {
            id: Date.now(), 
            name, 
            buyPrice, 
            sellPrice, 
            stock
        };
        writeData(`products/${newProduct.id}`, newProduct);

        document.getElementById('prodName').value = '';
        document.getElementById('prodBuyPrice').value = '';
        document.getElementById('prodSellPrice').value = '';
        document.getElementById('prodStock').value = '';
    }

    function deleteProduct(id) {
        if (confirm('Are you sure you want to delete this product?')) {
            writeData(`products/${id}`, null);
        }
    }

    function addDistribution() {
        const prodId = parseInt(document.getElementById('distProduct').value);
        const shop = document.getElementById('distShop').value.trim();
        
        // Sold Qty and Free Qty
        const soldQty = parseFloat(document.getElementById('distQty').value) || 0;
        const freeQty = parseFloat(document.getElementById('distFreeQty').value) || 0;
        
        const totalQtyToRemove = soldQty + freeQty;

        if (!prodId || !shop || totalQtyToRemove <= 0) {
            alert('Please fill in shop name and at least one quantity (Sold or Free)!');
            return;
        }

        const product = products.find(p => p.id === prodId);
        if (!product) return;

        if (product.stock < totalQtyToRemove) {
            alert(`Insufficient Stock! You only have ${product.stock} items.`);
            return;
        }

        // 1. Stock අඩු කිරීම (Sold + Free)
        const updatedProduct = {...product, stock: product.stock - totalQtyToRemove};
        writeData(`products/${product.id}`, updatedProduct);

        // 2. Distribution වාර්තාව එකතු කිරීම (Income calculated ONLY on Sold Qty)
        const newDistribution = {
            id: Date.now(),
            date: new Date().toISOString(),
            productName: product.name,
            shop,
            qty: soldQty,
            freeQty: freeQty,
            value: product.sellPrice * soldQty 
        };
        writeData(`distributions/${newDistribution.id}`, newDistribution);

        // Clear Inputs
        document.getElementById('distProduct').value = '';
        document.getElementById('distShop').value = '';
        document.getElementById('distQty').value = '';
        document.getElementById('distFreeQty').value = '';
        document.getElementById('distProductSearch').value = '';
    }

    function addRestock() {
        const prodId = parseInt(document.getElementById('restockProduct').value);
        const qty = parseFloat(document.getElementById('restockQty').value) || 0;

        if (!prodId || qty <= 0) {
            alert('Please enter all restock details!');
            return;
        }

        const product = products.find(p => p.id === prodId);
        if (!product) return;

        // 1. Stock වැඩි කිරීම
        const updatedProduct = {...product, stock: product.stock + qty};
        writeData(`products/${product.id}`, updatedProduct);

        // 2. Restock වාර්තාව එකතු කිරීම
        const newRestock = {
            id: Date.now(),
            date: new Date().toISOString(),
            productName: product.name,
            qty,
            cost: product.buyPrice * qty
        };
        writeData(`restocks/${newRestock.id}`, newRestock);

        document.getElementById('restockProduct').value = '';
        document.getElementById('restockQty').value = '';
        document.getElementById('restockProductSearch').value = '';
    }

    // --- Custom Dropdown Functions (Search & Highlight) ---

    function showDropdown(type) {
        document.getElementById(type + 'ProductDropdown').classList.remove('hidden');
        filterProducts(type);
    }

    function hideDropdown(type, event) {
        setTimeout(() => {
            const dropdown = document.getElementById(type + 'ProductDropdown');
            if (!event.relatedTarget || !event.relatedTarget.closest('#' + type + 'ProductDropdown')) {
                dropdown.classList.add('hidden');
            }
        }, 150);
    }

    function selectProduct(type, id, name) {
        const hiddenSelect = document.getElementById(type + 'Product');
        const searchInput = document.getElementById(type + 'ProductSearch');
        const dropdown = document.getElementById(type + 'ProductDropdown');

        hiddenSelect.value = id;
        searchInput.value = name;
        dropdown.classList.add('hidden');
        
        searchInput.classList.add('border-green-500');
        setTimeout(() => searchInput.classList.remove('border-green-500'), 500);
    }

    function filterProducts(type) {
        const input = document.getElementById(type + 'ProductSearch').value.toLowerCase();
        const dropdown = document.getElementById(type + 'ProductDropdown');
        
        let htmlContent = '';
        
        products.forEach(p => {
            const name = p.name.toLowerCase();
            const index = name.indexOf(input);
            
            if (!input || index !== -1) {
                let highlightedName = p.name;
                let currentStock = p.stock.toFixed(2);
                
                if (input && index !== -1) {
                    const start = p.name.substring(0, index);
                    const match = p.name.substring(index, index + input.length);
                    const end = p.name.substring(index + input.length);
                    highlightedName = `${start}<span class="bg-yellow-200 font-bold">${match}</span>${end}`;
                }
                
                const safeName = p.name.replace(/'/g, "\\'");
                
                htmlContent += `
                    <div class="p-3 cursor-pointer hover:bg-blue-100 transition flex justify-between items-center" 
                         onmousedown="selectProduct('${type}', ${p.id}, '${safeName}')"
                         tabindex="0">
                        <div>
                            <span class="text-gray-900">${highlightedName}</span>
                            <span class="text-gray-500 text-sm"> (Stock: ${currentStock})</span>
                        </div>
                    </div>
                `;
            }
        });

        if (htmlContent === '') {
            htmlContent = '<div class="p-3 text-gray-500">No results found</div>';
        }
        
        dropdown.innerHTML = htmlContent;
        dropdown.classList.remove('hidden');
    }

    // --- UI Updates ---

    function updateUI() {
        updateProductsTable();
        updateDistributionTable();
        updateRestockTable();
        updateLedger();
        updateProductSelects();
        setupDailyHistoryDate();
    }

    function updateProductsTable() {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = products.map(p => `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-3 font-medium text-gray-900">${p.name}</td>
                <td class="px-4 py-3 text-right text-gray-700">Rs. ${p.buyPrice.toFixed(2)}</td>
                <td class="px-4 py-3 text-right text-gray-700">Rs. ${p.sellPrice.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-semibold ${p.stock < 10 ? 'text-red-600' : 'text-gray-900'}">${p.stock.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-semibold text-blue-600">Rs. ${(p.buyPrice * p.stock).toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="deleteProduct(${p.id})" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    function updateDistributionTable() {
        const tbody = document.getElementById('distributionTableBody');
        tbody.innerHTML = distributions.slice().reverse().map(d => `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-3 text-gray-700">${new Date(d.date).toLocaleDateString('en-US')}</td>
                <td class="px-4 py-3 text-gray-900">${d.productName}</td>
                <td class="px-4 py-3 text-gray-900">${d.shop}</td>
                <td class="px-4 py-3 text-right font-semibold text-gray-900">${d.qty.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-semibold text-yellow-600 bg-yellow-50">${(d.freeQty || 0).toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">Rs. ${d.value.toFixed(2)}</td>
            </tr>
        `).join('');
    }

    function updateRestockTable() {
        const tbody = document.getElementById('restockTableBody');
        tbody.innerHTML = restocks.slice().reverse().map(r => `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-3 text-gray-700">${new Date(r.date).toLocaleDateString('en-US')}</td>
                <td class="px-4 py-3 text-gray-900">${r.productName}</td>
                <td class="px-4 py-3 text-right font-semibold text-gray-900">${r.qty.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-semibold text-red-600">Rs. ${r.cost.toFixed(2)}</td>
            </tr>
        `).join('');
    }

    function updateLedger() {
        const totalIncome = distributions.reduce((sum, d) => sum + d.value, 0);
        const totalExpenses = restocks.reduce((sum, r) => sum + r.cost, 0);
        const stockValue = products.reduce((sum, p) => sum + (p.buyPrice * p.stock), 0);

        document.getElementById('totalIncome').textContent = `Rs. ${totalIncome.toFixed(2)}`;
        document.getElementById('totalExpenses').textContent = `Rs. ${totalExpenses.toFixed(2)}`;
        document.getElementById('stockValue').textContent = `Rs. ${stockValue.toFixed(2)}`;

        // Stock Value Table Update
        const tbody = document.getElementById('stockValueTableBody');
        tbody.innerHTML = products.map(p => `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-4 py-3 font-medium text-gray-900">${p.name}</td>
                <td class="px-4 py-3 text-right text-gray-700">${p.stock.toFixed(2)}</td>
                <td class="px-4 py-3 text-right text-gray-700">Rs. ${p.buyPrice.toFixed(2)}</td>
                <td class="px-4 py-3 text-right font-semibold text-blue-600">Rs. ${(p.buyPrice * p.stock).toFixed(2)}</td>
            </tr>
        `).join('');
    }

    function updateProductSelects() {
        const distSelect = document.getElementById('distProduct');
        const restockSelect = document.getElementById('restockProduct');
        
        const options = products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        
        distSelect.innerHTML = '<option value="">Select Product</option>' + options;
        restockSelect.innerHTML = '<option value="">Select Product</option>' + options;

        const distSearch = document.getElementById('distProductSearch');
        const restockSearch = document.getElementById('restockProductSearch');
        if (distSearch) distSearch.value = '';
        if (restockSearch) restockSearch.value = '';
    }

    // --- Daily History Viewer Functions ---
    
    function setupDailyHistoryDate() {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('dailyHistoryDate');
        if (dateInput && !dateInput.value) {
            dateInput.value = today;
        }
    }

    function viewDailyHistory() {
        const dateString = document.getElementById('dailyHistoryDate').value;
        const resultsDiv = document.getElementById('dailyHistoryResults');
        resultsDiv.innerHTML = '';

        if (!dateString) {
            resultsDiv.innerHTML = '<p class="text-red-500">Please select a date!</p>';
            return;
        }

        const selectedDate = new Date(dateString);
        const startOfDay = new Date(selectedDate);
        startOfDay.setHours(0, 0, 0, 0);

        const endOfDay = new Date(selectedDate);
        endOfDay.setHours(23, 59, 59, 999);
        
        const dailyDist = distributions.filter(d => {
            const date = new Date(d.date);
            return date >= startOfDay && date <= endOfDay;
        });

        const dailyRestock = restocks.filter(r => {
            const date = new Date(r.date);
            return date >= startOfDay && date <= endOfDay;
        });

        if (dailyDist.length === 0 && dailyRestock.length === 0) {
            resultsDiv.innerHTML = `<p class="text-gray-500">No transactions recorded for ${new Date(dateString).toLocaleDateString('en-US', { dateStyle: 'long' })}.</p>`;
            return;
        }

        const distIncome = dailyDist.reduce((sum, d) => sum + d.value, 0);
        const restockCost = dailyRestock.reduce((sum, r) => sum + r.cost, 0);
        const netChange = distIncome - restockCost;

        let html = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <h3 class="font-bold text-lg text-blue-800">Summary for ${new Date(dateString).toLocaleDateString('en-US', { dateStyle: 'long' })}</h3>
                <div class="grid grid-cols-3 gap-4 mt-2">
                    <div><p class="text-sm text-gray-600">Total Income:</p><p class="font-bold text-green-600">Rs. ${distIncome.toFixed(2)}</p></div>
                    <div><p class="text-sm text-gray-600">Total Expense:</p><p class="font-bold text-red-600">Rs. ${restockCost.toFixed(2)}</p></div>
                    <div><p class="text-sm text-gray-600">Net Change:</p><p class="font-bold ${netChange >= 0 ? 'text-green-700' : 'text-red-700'}">Rs. ${netChange.toFixed(2)}</p></div>
                </div>
            </div>
        `;

        if (dailyDist.length > 0) {
            html += `<h4 class="font-semibold text-gray-800 mt-6 mb-3">Distributions (${dailyDist.length})</h4>
                     <div class="overflow-x-auto"><table class="w-full min-w-[500px] border-collapse">
                     <thead class="bg-green-100"><tr class="text-left text-sm text-green-800">
                        <th class="px-4 py-2 border-b">Time</th><th class="px-4 py-2 border-b">Product</th>
                        <th class="px-4 py-2 border-b">Shop</th>
                        <th class="px-4 py-2 border-b text-right">Sold Qty</th>
                        <th class="px-4 py-2 border-b text-right">Free Qty</th>
                        <th class="px-4 py-2 border-b text-right">Income</th></tr></thead>
                     <tbody>`;
            dailyDist.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(d => {
                const time = new Date(d.date).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                html += `<tr><td class="px-4 py-2 text-sm">${time}</td><td class="px-4 py-2 text-sm">${d.productName}</td>
                         <td class="px-4 py-2 text-sm">${d.shop}</td>
                         <td class="px-4 py-2 text-sm text-right">${d.qty.toFixed(2)}</td>
                         <td class="px-4 py-2 text-sm text-right text-yellow-600">${(d.freeQty || 0).toFixed(2)}</td>
                         <td class="px-4 py-2 text-sm text-right text-green-600">Rs. ${d.value.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        }

        if (dailyRestock.length > 0) {
            html += `<h4 class="font-semibold text-gray-800 mt-6 mb-3">Restocks (${dailyRestock.length})</h4>
                     <div class="overflow-x-auto"><table class="w-full min-w-[500px] border-collapse">
                     <thead class="bg-red-100"><tr class="text-left text-sm text-red-800">
                        <th class="px-4 py-2 border-b">Time</th><th class="px-4 py-2 border-b">Product</th>
                        <th class="px-4 py-2 border-b text-right">Qty</th><th class="px-4 py-2 border-b text-right">Expense</th>
                        </tr></thead>
                     <tbody>`;
            dailyRestock.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
                const time = new Date(r.date).toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                html += `<tr><td class="px-4 py-2 text-sm">${time}</td><td class="px-4 py-2 text-sm">${r.productName}</td>
                         <td class="px-4 py-2 text-sm text-right">${r.qty.toFixed(2)}</td>
                         <td class="px-4 py-2 text-sm text-right text-red-600">Rs. ${r.cost.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        }

        resultsDiv.innerHTML += html;
    }

    // --- PDF Report Generation (Using jsPDF and autoTable) ---

    function generateReport() {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;

        if (!startDate || !endDate) {
            alert('Please select the date range!');
            return;
        }

        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);

        const filteredDist = distributions.filter(d => {
            const date = new Date(d.date);
            return date >= start && date <= end;
        });

        const filteredRestock = restocks.filter(r => {
            const date = new Date(r.date);
            return date >= start && date <= end;
        });

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // --- Summary Calculations ---
        const totalIncome = filteredDist.reduce((sum, d) => sum + d.value, 0);
        const totalExpenses = filteredRestock.reduce((sum, r) => sum + r.cost, 0);
        const netProfit = totalIncome - totalExpenses;
        const stockValue = products.reduce((sum, p) => sum + (p.buyPrice * p.stock), 0);

        // --- Report Header ---
        doc.setFont('Helvetica', 'bold');
        doc.setFontSize(18);
        doc.text('Distribution Agency Financial Report', 105, 20, { align: 'center' });
        
        doc.setFontSize(12);
        const reportDateRange = `${new Date(startDate).toLocaleDateString('en-US')} - ${new Date(endDate).toLocaleDateString('en-US')}`;
        doc.text(`Period: ${reportDateRange}`, 105, 30, { align: 'center' });

        let y = 45;

        // --- 1. Financial Summary Table ---
        doc.setFontSize(14);
        doc.text('1. Financial Summary', 20, y);
        y += 5;

        const summaryHeaders = ["Metric", "Value"];
        const summaryData = [
            ["Total Sales Income", `Rs. ${totalIncome.toFixed(2)}`],
            ["Total Restock Cost (Expenses)", `Rs. ${totalExpenses.toFixed(2)}`],
            ["Net Profit/Loss", `Rs. ${netProfit.toFixed(2)}`],
            ["Current Stock Value (at Cost)", `Rs. ${stockValue.toFixed(2)}`]
        ];
        
        doc.autoTable({
            startY: y + 5,
            head: [summaryHeaders],
            body: summaryData,
            theme: 'grid',
            headStyles: { fillColor: [59, 130, 246] },
            columnStyles: { 1: { halign: 'right' } }
        });
        y = doc.autoTable.previous.finalY + 15;


        // --- 2. Distribution Details Table ---
        doc.setFontSize(14);
        doc.text('2. Distribution (Sales) Details', 20, y);
        y += 5;

        const distHeaders = ["Date", "Product", "Shop", "Sold Qty", "Free Qty", "Sale Value"];
        const distData = filteredDist.map(d => [
            new Date(d.date).toLocaleDateString('en-US'),
            d.productName,
            d.shop,
            d.qty.toFixed(2),
            (d.freeQty || 0).toFixed(2),
            `Rs. ${d.value.toFixed(2)}`
        ]);

        doc.autoTable({
            startY: y + 5,
            head: [distHeaders],
            body: distData,
            theme: 'striped',
            headStyles: { fillColor: [75, 175, 80] },
            columnStyles: {
                3: { halign: 'right' },
                4: { halign: 'right' },
                5: { halign: 'right' }
            }
        });
        y = doc.autoTable.previous.finalY + 15;
        if (y > 250) {
            doc.addPage();
            y = 20;
        }


        // --- 3. Restock Details Table ---
        doc.setFontSize(14);
        doc.text('3. Restock (Expense) Details', 20, y);
        y += 5;

        const restockHeaders = ["Date", "Product", "Qty", "Cost (Expense)"];
        const restockData = filteredRestock.map(r => [
            new Date(r.date).toLocaleDateString('en-US'),
            r.productName,
            r.qty.toFixed(2),
            `Rs. ${r.cost.toFixed(2)}`
        ]);

        doc.autoTable({
            startY: y + 5,
            head: [restockHeaders],
            body: restockData,
            theme: 'striped',
            headStyles: { fillColor: [239, 68, 68] },
            columnStyles: {
                2: { halign: 'right' },
                3: { halign: 'right' }
            }
        });

        doc.save(`Distribution_Report_${startDate}_${endDate}.pdf`);
    }

    // --- Initialization ---

    // Initialize PDF report date pickers to show the last 30 days
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reportEndDate').value = today;
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('reportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    
    // Initial dot setup
    updateDots();

</script>
</body>
</html>

