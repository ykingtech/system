<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .glass { background: #ffffff; border: 1px solid #e5e7eb; }
        .shadow-custom { box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; ring-color: #3b82f6; }
        .key:active { background: #2563eb; color: white; transform: scale(0.95); }
        .d-none { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div id="loginScreen" class="fixed inset-0 z-[5000] bg-gray-100 flex items-center justify-center p-4">
    <div class="glass rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Login</h1>
        <p class="text-gray-500 mb-6">Enter PIN to access system</p>
        
        <div class="flex justify-center space-x-3 mb-6">
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot1"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot2"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot3"></div>
            <div class="w-5 h-5 bg-gray-300 rounded-full transition-colors" id="dot4"></div>
        </div>

        <div class="grid grid-cols-3 gap-4 text-xl font-bold select-none mb-4">
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('1')">1</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('2')">2</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('3')">3</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('4')">4</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('5')">5</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('6')">6</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('7')">7</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('8')">8</div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('9')">9</div>
            <div></div>
            <div class="key bg-white p-4 rounded-xl shadow cursor-pointer hover:bg-blue-50" onclick="pressKey('0')">0</div>
            <div class="key bg-red-500 text-white p-4 rounded-xl shadow cursor-pointer hover:bg-red-600" onclick="deleteKey()">âŒ«</div>
        </div>
        <p id="errorMsg" class="text-red-600 hidden font-bold">Incorrect PIN!</p>
        
        <div class="mt-6 text-xs text-gray-400">
            Powered by <span class="font-semibold text-gray-500">The Kina Solutions</span>
        </div>
    </div>
</div>

<div id="adminPinModal" class="fixed inset-0 z-[6000] bg-black/60 hidden items-center justify-center p-4">
    <div class="glass rounded-2xl shadow-2xl p-6 w-full max-w-xs text-center relative animate-[fadeIn_0.2s_ease-out]">
        <button onclick="closeAdminModal()" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        <h2 class="text-xl font-bold text-gray-800 mb-1">Admin Verification</h2>
        <p class="text-xs text-gray-500 mb-4" id="adminActionText">Enter PIN to confirm action</p>
        
        <div class="flex justify-center space-x-2 mb-4">
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot1"></div>
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot2"></div>
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot3"></div>
            <div class="w-4 h-4 bg-gray-300 rounded-full transition-colors" id="adot4"></div>
        </div>

        <div class="grid grid-cols-3 gap-2 text-lg font-bold select-none">
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('1')">1</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('2')">2</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('3')">3</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('4')">4</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('5')">5</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('6')">6</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('7')">7</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('8')">8</div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('9')">9</div>
            <div></div>
            <div class="key bg-gray-50 p-3 rounded-lg shadow-sm cursor-pointer active:bg-blue-100" onclick="pressAdminKey('0')">0</div>
            <div class="key bg-red-100 text-red-600 p-3 rounded-lg shadow-sm cursor-pointer active:bg-red-200" onclick="deleteAdminKey()">âŒ«</div>
        </div>
    </div>
</div>

<div id="mainSystem" class="min-h-screen flex flex-col" style="display: none;">

    <header class="glass border-b border-gray-200 sticky top-0 z-40 bg-white/90 backdrop-blur">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-xl">C</div>
                    <h1 class="text-xl font-bold text-gray-800">Distribution System</h1>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-medium">Logout</button>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 overflow-x-auto">
        <div class="glass rounded-xl p-2 inline-flex space-x-2 shadow-custom min-w-max bg-white">
            <button onclick="showTab('products')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="products">Products</button>
            <button onclick="showTab('distribution')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="distribution">Sales</button>
            <button onclick="showTab('returns')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="returns">Returns</button>
            <button onclick="showTab('restock')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="restock">Restock</button>
            <button onclick="showTab('ledger')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="ledger">Ledger</button>
            <button onclick="showTab('reports')" class="tab-btn px-4 py-2 rounded-lg font-medium transition text-sm" data-tab="reports">Reports</button>
        </div>
    </div>

    <div class="flex-grow">
        
        <div id="productsTab" class="container mx-auto px-4 pb-8 tab-content">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6" id="productFormTitle">Add New Product</h2>
                <input type="hidden" id="editingProductId">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <input type="text" id="prodName" placeholder="Product Name" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <input type="number" id="prodBuyPrice" placeholder="Buy Price" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <input type="number" id="prodSellPrice" placeholder="Sell Price" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <input type="number" id="prodStock" placeholder="Stock" class="px-4 py-2 border border-gray-300 rounded-lg focus:border-blue-500">
                    <button id="saveProductBtn" onclick="saveProduct()" class="bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition">Add</button>
                    <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-gray-500 text-white py-2 rounded-lg font-bold hover:bg-gray-600 transition">Cancel</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Stock List</h2>
                    <input type="text" id="productListSearch" placeholder="Search..." class="px-4 py-2 border rounded-lg focus:border-blue-500" onkeyup="updateProductsTable()">
                </div>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-blue-600 text-white uppercase">
                            <tr><th class="px-4 py-3">Name</th><th class="px-4 py-3 text-right">Buy</th><th class="px-4 py-3 text-right">Sell</th><th class="px-4 py-3 text-right">Stock</th><th class="px-4 py-3 text-right">Value</th><th class="px-4 py-3 text-center">Action</th></tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="distributionTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">New Sale</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="relative lg:col-span-2">
                        <select id="distProduct" class="hidden"><option value="">Select</option></select>
                        <input type="text" id="distProductSearch" placeholder="Search Product..." class="w-full px-4 py-2 border rounded-lg focus:border-blue-500" onfocus="showDropdown('dist')" onblur="hideDropdown('dist', event)" onkeyup="filterProducts('dist')">
                        <div id="distProductDropdown" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="text" id="distShop" placeholder="Shop Name" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="distQty" placeholder="Sold Qty" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="distFreeQty" placeholder="Free Qty" class="px-4 py-2 border rounded-lg bg-yellow-50 focus:border-yellow-500">
                    <button onclick="addDistribution()" class="bg-blue-600 text-white py-2 rounded-lg font-bold lg:col-span-5 hover:bg-blue-700 transition">Submit Sale</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <h2 class="text-xl font-bold mb-4">Recent Sales</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-blue-600 text-white uppercase">
                            <tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3">Shop</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Free</th><th class="p-3 text-right">Total</th></tr>
                        </thead>
                        <tbody id="distributionTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="returnsTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Product Returns</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div class="relative lg:col-span-2">
                        <select id="retProduct" class="hidden"><option value="">Select</option></select>
                        <input type="text" id="retProductSearch" placeholder="Search Product..." class="w-full px-4 py-2 border rounded-lg focus:border-blue-500" onfocus="showDropdown('ret')" onblur="hideDropdown('ret', event)" onkeyup="filterProducts('ret')">
                        <div id="retProductDropdown" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="text" id="retShop" placeholder="Shop Name" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <input type="number" id="retQty" placeholder="Return Qty" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    
                    <select id="retReason" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                        <option value="Unsold">Unsold / Not Sold</option>
                        <option value="Expired">Expired</option>
                        <option value="Damaged">Damaged</option>
                    </select>

                    <div class="flex items-center gap-2 lg:col-span-5 bg-orange-50 p-2 rounded border border-orange-200">
                        <input type="checkbox" id="retAddToStock" class="w-5 h-5 text-orange-600 rounded focus:ring-orange-500" checked>
                        <label for="retAddToStock" class="text-sm font-bold text-orange-800 cursor-pointer">Add back to Stock? (Uncheck if Damaged/Expired)</label>
                    </div>

                    <button onclick="addReturn()" class="bg-orange-600 text-white py-2 rounded-lg font-bold lg:col-span-5 hover:bg-orange-700 transition">Submit Return</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <h2 class="text-xl font-bold mb-4">Recent Returns</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-orange-600 text-white uppercase">
                            <tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3">Shop</th><th class="p-3">Reason</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Value (Deducted)</th></tr>
                        </thead>
                        <tbody id="returnsTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="restockTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass rounded-xl shadow-custom p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Restock Inventory</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <select id="restockProduct" class="hidden"><option value="">Select</option></select>
                        <input type="text" id="restockProductSearch" placeholder="Search Product..." class="w-full px-4 py-2 border rounded-lg focus:border-blue-500" onfocus="showDropdown('restock')" onblur="hideDropdown('restock', event)" onkeyup="filterProducts('restock')">
                        <div id="restockProductDropdown" class="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-xl max-h-60 overflow-y-auto hidden"></div>
                    </div>
                    <input type="number" id="restockQty" placeholder="Quantity" class="px-4 py-2 border rounded-lg focus:border-blue-500">
                    <button onclick="addRestock()" class="bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700 transition">Restock</button>
                </div>
            </div>
            <div class="glass rounded-xl shadow-custom p-6">
                <h2 class="text-xl font-bold mb-4">Recent Restocks</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-purple-600 text-white uppercase">
                            <tr><th class="p-3">Date</th><th class="p-3">Product</th><th class="p-3 text-right">Qty</th><th class="p-3 text-right">Cost</th></tr>
                        </thead>
                        <tbody id="restockTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="ledgerTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            
            <div class="glass p-4 rounded-xl mb-6 border border-blue-100 flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From</label>
                    <input type="date" id="ledgerStart" class="border p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" onchange="filterLedger()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To</label>
                    <input type="date" id="ledgerEnd" class="border p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-gray-700" onchange="filterLedger()">
                </div>
                <button onclick="resetLedgerDates()" class="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-lg font-medium transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Reset to This Month
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="glass p-4 rounded-xl bg-green-600 text-white shadow-lg">
                    <p class="text-sm opacity-80">Income (Selected Period)</p><p class="text-2xl font-bold" id="totalIncome">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-red-600 text-white shadow-lg">
                    <p class="text-sm opacity-80">Expenses (Selected Period)</p><p class="text-2xl font-bold" id="totalExpenses">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-orange-500 text-white shadow-lg">
                    <p class="text-sm opacity-80">Returns (Selected Period)</p><p class="text-2xl font-bold" id="totalReturnsVal">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-blue-700 text-white shadow-lg">
                    <p class="text-sm opacity-80">Net Profit (Selected Period)</p><p class="text-2xl font-bold" id="netProfit">Rs. 0.00</p>
                </div>
                <div class="glass p-4 rounded-xl bg-gray-800 text-white shadow-lg">
                    <p class="text-sm opacity-80">Current Stock Value (Total)</p><p class="text-2xl font-bold" id="stockValue">Rs. 0.00</p>
                </div>
            </div>
            <div class="glass p-6 rounded-xl border border-gray-200">
                <h2 class="font-bold mb-4 text-gray-800 text-lg">Current Stock Overview</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm text-left text-gray-700">
                        <thead class="bg-gray-800 text-white uppercase">
                            <tr><th class="p-3">Product</th><th class="p-3 text-right">Stock</th><th class="p-3 text-right">Cost Value</th></tr>
                        </thead>
                        <tbody id="stockValueTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reportsTab" class="container mx-auto px-4 pb-8 tab-content hidden">
            <div class="glass p-6 rounded-xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Generate Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="reportStartDate" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="reportEndDate" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <button onclick="generateFinancialReport()" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                        <span>ðŸ“„</span> Download Financial Summary
                    </button>
                    <button onclick="generateAuditReport()" class="bg-gray-800 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-900 transition flex items-center justify-center gap-2">
                        <span>ðŸ“Š</span> Download Detailed Audit Report
                    </button>
                </div>
            </div>
        </div>

    </div>

    <footer class="text-center py-6 text-gray-500 text-sm mt-auto bg-white border-t border-gray-200">
        Powered by <span class="font-semibold text-blue-600">The Kina Solutions</span>
    </footer>

</div>

<script>
    /* --- LOGIN LOGIC --- */
    let pin = "1234"; 
    let inputPin = "";
    
    function updateDots() { 
        for(let i=1;i<=4;i++) {
            const dot = document.getElementById("dot"+i);
            if(i <= inputPin.length) {
                dot.classList.remove("bg-gray-300");
                dot.classList.add("bg-blue-600");
            } else {
                dot.classList.remove("bg-blue-600");
                dot.classList.add("bg-gray-300");
            }
        }
    }
    
    function pressKey(n) { 
        if(inputPin.length<4) { 
            inputPin+=n; 
            updateDots(); 
            if(inputPin.length===4) checkPin(); 
        } 
    }
    
    function deleteKey() { 
        inputPin=inputPin.slice(0,-1); 
        document.getElementById("errorMsg").classList.add("hidden"); 
        updateDots(); 
    }
    
    function checkPin() {
        if(inputPin===pin) { 
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("mainSystem").style.display = "flex";
            showTab('products'); 
        } else { 
            document.getElementById("errorMsg").classList.remove("hidden"); 
            inputPin=""; 
            setTimeout(()=>{
                document.getElementById("errorMsg").classList.add("hidden"); 
                updateDots();
            },1000); 
        }
    }
    
    function logout() {
        document.getElementById("mainSystem").style.display = "none";
        document.getElementById("loginScreen").style.display = "flex";
        inputPin = "";
        updateDots();
    }

    /* --- ADMIN ACTION PIN MODAL LOGIC --- */
    let adminPin = "";
    let pendingAction = null; 
    let pendingTargetId = null;

    function openAdminModal(action, id) {
        pendingAction = action;
        pendingTargetId = id;
        adminPin = "";
        updateAdminDots();
        document.getElementById("adminActionText").innerText = action === 'edit' ? "Enter PIN to Edit Product" : "Enter PIN to Delete Product";
        document.getElementById("adminPinModal").classList.remove("hidden");
        document.getElementById("adminPinModal").classList.add("flex");
    }

    function closeAdminModal() {
        document.getElementById("adminPinModal").classList.add("hidden");
        document.getElementById("adminPinModal").classList.remove("flex");
        adminPin = "";
        pendingAction = null;
        pendingTargetId = null;
    }

    function updateAdminDots() {
        for(let i=1;i<=4;i++) {
            const dot = document.getElementById("adot"+i);
            if(i <= adminPin.length) {
                dot.classList.remove("bg-gray-300");
                dot.classList.add("bg-blue-600");
            } else {
                dot.classList.remove("bg-blue-600");
                dot.classList.add("bg-gray-300");
            }
        }
    }

    function pressAdminKey(n) {
        if(adminPin.length < 4) {
            adminPin += n;
            updateAdminDots();
            if(adminPin.length === 4) checkAdminPin();
        }
    }

    function deleteAdminKey() {
        adminPin = adminPin.slice(0, -1);
        updateAdminDots();
    }

    function checkAdminPin() {
        if(adminPin === pin) {
            const action = pendingAction;
            const target = pendingTargetId;
            // IMPORTANT: Perform the action BEFORE closing/resetting
            if(action === 'edit') editProductReal(target);
            if(action === 'delete') deleteProductReal(target);
            
            // Then close the modal
            closeAdminModal();
        } else {
            alert("Incorrect PIN!");
            adminPin = "";
            updateAdminDots();
        }
    }

    /* --- FIREBASE SETUP --- */
    const firebaseApp = firebase.initializeApp({
        apiKey: "AIzaSyB_O5J7N3OocENr-De87sXAf5-ofpFtBLs",
        authDomain: "pos-app-37e46.firebaseapp.com",
        databaseURL: "https://pos-app-37e46-default-rtdb.firebaseio.com",
        projectId: "pos-app-37e46",
        storageBucket: "pos-app-37e46.firebasestorage.app",
        messagingSenderId: "110849552548",
        appId: "1:110849552548:web:fa95ce2f798ccdae8eb631"
    });
    const database = firebaseApp.database();
    
    let products=[], distributions=[], restocks=[], returns=[];
    let currentTab = 'products';

    function writeData(path, data) { database.ref(path).set(data).catch(e=>console.error(e)); }

    function initializeDatabaseListeners() {
        database.ref('products').on('value', s => { products = s.val() ? Object.values(s.val()) : []; updateUI(); });
        database.ref('distributions').limitToLast(200).on('value', s => { distributions = s.val() ? Object.values(s.val()).sort((a,b)=>new Date(a.date)-new Date(b.date)) : []; if(currentTab==='distribution' || currentTab==='ledger') updateUI(); });
        database.ref('restocks').limitToLast(200).on('value', s => { restocks = s.val() ? Object.values(s.val()).sort((a,b)=>new Date(a.date)-new Date(b.date)) : []; if(currentTab==='restock' || currentTab==='ledger') updateUI(); });
        database.ref('returns').limitToLast(200).on('value', s => { returns = s.val() ? Object.values(s.val()).sort((a,b)=>new Date(a.date)-new Date(b.date)) : []; if(currentTab==='returns' || currentTab==='ledger') updateUI(); });
    }

    function showTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(e=>{e.classList.remove('bg-blue-600','text-white'); e.classList.add('text-gray-600','hover:bg-gray-100');});
        document.getElementById(tab+'Tab').classList.remove('hidden');
        document.querySelector(`[data-tab="${tab}"]`).classList.remove('text-gray-600','hover:bg-gray-100');
        document.querySelector(`[data-tab="${tab}"]`).classList.add('bg-blue-600','text-white');
        updateUI();
    }

    // --- Product Functions ---
    function saveProduct() {
        const id = document.getElementById('editingProductId').value || Date.now();
        const name = document.getElementById('prodName').value;
        const stock = parseFloat(document.getElementById('prodStock').value)||0;
        if(!name) return alert("Name required");
        const data = {
            id: parseInt(id), name,
            buyPrice: parseFloat(document.getElementById('prodBuyPrice').value)||0,
            sellPrice: parseFloat(document.getElementById('prodSellPrice').value)||0,
            stock
        };
        writeData(`products/${data.id}`, data);
        cancelEdit();
    }

    function editProduct(id) { openAdminModal('edit', id); }
    function deleteProduct(id) { openAdminModal('delete', id); }

    function editProductReal(id) {
        const p = products.find(x=>x.id===id);
        if(!p) return; // Safety check
        document.getElementById('editingProductId').value=p.id;
        document.getElementById('prodName').value=p.name;
        document.getElementById('prodBuyPrice').value=p.buyPrice;
        document.getElementById('prodSellPrice').value=p.sellPrice;
        document.getElementById('prodStock').value=p.stock;
        document.getElementById('productFormTitle').innerText="Edit Product";
        document.getElementById('saveProductBtn').innerText="Update";
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        document.getElementById('productsTab').scrollIntoView({behavior:'smooth'});
    }

    function cancelEdit() {
        document.getElementById('editingProductId').value='';
        document.getElementById('prodName').value=''; document.getElementById('prodStock').value='';
        document.getElementById('prodBuyPrice').value=''; document.getElementById('prodSellPrice').value='';
        document.getElementById('productFormTitle').innerText="Add New Product";
        document.getElementById('saveProductBtn').innerText="Add";
        document.getElementById('cancelEditBtn').classList.add('hidden');
    }

    function deleteProductReal(id) {
        if(confirm("Are you sure you want to permanently delete this product?")) {
            writeData(`products/${id}`, null); 
        }
    }

    // --- Transaction Functions ---
    function addDistribution() {
        const pid = parseInt(document.getElementById('distProduct').value);
        const shop = document.getElementById('distShop').value;
        const qty = parseFloat(document.getElementById('distQty').value)||0;
        const free = parseFloat(document.getElementById('distFreeQty').value)||0;
        if(!pid || !shop) return alert("Select product and enter shop");
        
        const p = products.find(x=>x.id===pid);
        if(p.stock < (qty+free)) return alert("Low Stock!");
        
        writeData(`products/${p.id}`, {...p, stock: p.stock-(qty+free)});
        const dist = { id: Date.now(), date: new Date().toISOString(), productName: p.name, shop, qty, freeQty: free, value: p.sellPrice*qty };
        writeData(`distributions/${dist.id}`, dist);
        
        document.getElementById('distQty').value=''; document.getElementById('distFreeQty').value='';
        document.getElementById('distShop').value=''; 
        document.getElementById('distProduct').value=''; document.getElementById('distProductSearch').value='';
    }

    function addRestock() {
        const pid = parseInt(document.getElementById('restockProduct').value);
        const qty = parseFloat(document.getElementById('restockQty').value)||0;
        if(!pid || qty<=0) return alert("Invalid Input");
        const p = products.find(x=>x.id===pid);
        
        writeData(`products/${p.id}`, {...p, stock: p.stock+qty});
        const rs = { id: Date.now(), date: new Date().toISOString(), productName: p.name, qty, cost: p.buyPrice*qty };
        writeData(`restocks/${rs.id}`, rs);
        
        document.getElementById('restockQty').value='';
        document.getElementById('restockProduct').value=''; document.getElementById('restockProductSearch').value='';
    }

    // --- Returns Logic ---
    function addReturn() {
        const pid = parseInt(document.getElementById('retProduct').value);
        const shop = document.getElementById('retShop').value;
        const qty = parseFloat(document.getElementById('retQty').value)||0;
        const reason = document.getElementById('retReason').value;
        const addToStock = document.getElementById('retAddToStock').checked;

        if(!pid || !shop || qty<=0) return alert("Please fill all fields");

        const p = products.find(x=>x.id===pid);
        
        if(addToStock) {
            writeData(`products/${p.id}`, {...p, stock: p.stock + qty});
        }

        const ret = {
            id: Date.now(),
            date: new Date().toISOString(),
            productName: p.name,
            shop,
            qty,
            reason,
            addedToStock: addToStock,
            value: p.sellPrice * qty
        };
        writeData(`returns/${ret.id}`, ret);

        document.getElementById('retQty').value=''; document.getElementById('retShop').value='';
        document.getElementById('retProduct').value=''; document.getElementById('retProductSearch').value='';
        alert("Return Added!");
    }

    // --- UI Helpers ---
    function showDropdown(t) { document.getElementById(t+'ProductDropdown').classList.remove('hidden'); filterProducts(t); }
    function hideDropdown(t, e) { setTimeout(()=>{ if(!e.relatedTarget?.closest('#'+t+'ProductDropdown')) document.getElementById(t+'ProductDropdown').classList.add('hidden'); }, 150); }
    
    function filterProducts(t) {
        const val = document.getElementById(t+'ProductSearch').value.toLowerCase();
        const list = products.filter(p=>p.name.toLowerCase().includes(val));
        const div = document.getElementById(t+'ProductDropdown');
        div.innerHTML = list.length ? list.map(p=>`<div class="p-2 hover:bg-blue-50 cursor-pointer border-b last:border-b-0" onclick="selectProduct('${t}',${p.id},'${p.name.replace(/'/g,"\\'")}')"><div class="font-medium">${p.name}</div><div class="text-xs text-gray-500">Stock: ${p.stock}</div></div>`).join('') : '<div class="p-2 text-gray-500 italic">No items found</div>';
    }
    
    function selectProduct(t, id, name) {
        document.getElementById(t+'Product').value = id;
        document.getElementById(t+'ProductSearch').value = name;
        document.getElementById(t+'ProductDropdown').classList.add('hidden');
    }

    // --- Ledger Filters ---
    function initLedgerDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0); 
        
        const formatDate = (d) => {
            let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        };
        
        document.getElementById('ledgerStart').value = formatDate(firstDay);
        document.getElementById('ledgerEnd').value = formatDate(lastDay);
    }

    function filterLedger() {
        updateUI();
    }

    function resetLedgerDates() {
        initLedgerDates();
        updateUI();
    }

    // --- Updates ---
    function updateUI() {
        if(currentTab==='products') {
            const tbody = document.getElementById('productsTableBody');
            const search = document.getElementById('productListSearch').value.toLowerCase();
            const list = products.filter(p=>p.name.toLowerCase().includes(search));
            tbody.innerHTML = list.map(p=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-right">${p.buyPrice}</td><td class="p-3 text-right">${p.sellPrice}</td><td class="p-3 text-right font-bold ${p.stock<10?'text-red-600':''}">${p.stock}</td><td class="p-3 text-right">${(p.buyPrice*p.stock).toFixed(2)}</td><td class="p-3 text-center"><button onclick="editProduct(${p.id})" class="text-blue-600 hover:text-blue-800 mr-3 font-medium">Edit</button><button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700 font-medium">Del</button></td></tr>`).join('');
        }
        if(currentTab==='distribution') {
            const tbody = document.getElementById('distributionTableBody');
            tbody.innerHTML = distributions.slice().reverse().map(d=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 text-gray-600">${new Date(d.date).toLocaleDateString()}</td><td class="p-3 font-medium">${d.productName}</td><td class="p-3 text-gray-600">${d.shop}</td><td class="p-3 text-right font-bold">${d.qty}</td><td class="p-3 text-right text-orange-600 font-medium">${d.freeQty||0}</td><td class="p-3 text-right font-bold text-green-600">${d.value.toFixed(2)}</td></tr>`).join('');
        }
        if(currentTab==='restock') {
            const tbody = document.getElementById('restockTableBody');
            tbody.innerHTML = restocks.slice().reverse().map(r=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 text-gray-600">${new Date(r.date).toLocaleDateString()}</td><td class="p-3 font-medium">${r.productName}</td><td class="p-3 text-right font-bold">${r.qty}</td><td class="p-3 text-right font-bold text-red-600">${r.cost.toFixed(2)}</td></tr>`).join('');
        }
        if(currentTab==='returns') {
            const tbody = document.getElementById('returnsTableBody');
            tbody.innerHTML = returns.slice().reverse().map(r=>`<tr class="hover:bg-gray-50 border-b"><td class="p-3 text-gray-600">${new Date(r.date).toLocaleDateString()}</td><td class="p-3 font-medium">${r.productName}</td><td class="p-3 text-gray-600">${r.shop}</td><td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${r.reason==='Damaged'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}">${r.reason}</span> ${r.addedToStock?'<span class="text-green-600 font-bold text-xs ml-1">(+Stock)</span>':''}</td><td class="p-3 text-right font-bold">${r.qty}</td><td class="p-3 text-right text-red-500 font-medium">-${r.value.toFixed(2)}</td></tr>`).join('');
        }
        if(currentTab==='ledger') {
            const sDate = new Date(document.getElementById('ledgerStart').value);
            const eDate = new Date(document.getElementById('ledgerEnd').value);
            eDate.setHours(23,59,59,999); 

            // Filter data based on selected range
            const fDist = distributions.filter(d => { const dDate = new Date(d.date); return dDate >= sDate && dDate <= eDate; });
            const fRest = restocks.filter(r => { const rDate = new Date(r.date); return rDate >= sDate && rDate <= eDate; });
            const fRet = returns.filter(r => { const rDate = new Date(r.date); return rDate >= sDate && rDate <= eDate; });

            const inc = fDist.reduce((a,b)=>a+b.value,0);
            const exp = fRest.reduce((a,b)=>a+b.cost,0);
            const retVal = fRet.reduce((a,b)=>a+b.value,0);
            const net = inc - exp - retVal;
            
            const stv = products.reduce((a,b)=>a+(b.buyPrice*b.stock),0);
            
            document.getElementById('totalIncome').innerText = "Rs. "+inc.toFixed(2);
            document.getElementById('totalExpenses').innerText = "Rs. "+exp.toFixed(2);
            document.getElementById('totalReturnsVal').innerText = "Rs. "+retVal.toFixed(2);
            document.getElementById('netProfit').innerText = "Rs. "+net.toFixed(2);
            document.getElementById('stockValue').innerText = "Rs. "+stv.toFixed(2);
            
            document.getElementById('stockValueTableBody').innerHTML = products.map(p=>`<tr class="border-b"><td class="p-3 font-medium">${p.name}</td><td class="p-3 text-right">${p.stock}</td><td class="p-3 text-right font-medium text-gray-700">${(p.buyPrice*p.stock).toFixed(2)}</td></tr>`).join('');
        }
        
        const types = ['dist', 'restock', 'ret'];
        types.forEach(t => {
            const sVal = document.getElementById(t+'ProductSearch')?.value;
            if(!sVal) document.getElementById(t+'Product').value = "";
        });
    }

    // --- Reports ---
    function generateFinancialReport() {
        const s = new Date(document.getElementById('reportStartDate').value);
        const e = new Date(document.getElementById('reportEndDate').value); e.setHours(23,59,59);
        if(isNaN(s)||isNaN(e)) return alert("Select Dates");

        const fDist = distributions.filter(d=>{const x=new Date(d.date); return x>=s && x<=e});
        const fRest = restocks.filter(r=>{const x=new Date(r.date); return x>=s && x<=e});
        const fRet = returns.filter(r=>{const x=new Date(r.date); return x>=s && x<=e});

        const doc = new window.jspdf.jsPDF();
        doc.setFontSize(18); doc.text("Financial Summary Report", 14, 15);
        doc.setFontSize(10); doc.text(`Period: ${s.toLocaleDateString()} - ${e.toLocaleDateString()}`, 14, 22);
        
        const inc = fDist.reduce((a,b)=>a+b.value,0);
        const exp = fRest.reduce((a,b)=>a+b.cost,0);
        const ret = fRet.reduce((a,b)=>a+b.value,0);
        const net = inc - exp - ret;

        let y=30;
        doc.autoTable({startY:y, head:[['Metric', 'Amount']], body:[
            ['Total Sales', `Rs. ${inc.toFixed(2)}`],
            ['Restock Expenses', `Rs. ${exp.toFixed(2)}`],
            ['Returns Deductions', `Rs. ${ret.toFixed(2)}`],
            ['Net Profit', `Rs. ${net.toFixed(2)}`]
        ], theme: 'grid', headStyles: {fillColor:[41, 128, 185]}});
        
        doc.save("financial_summary.pdf");
    }

    function generateAuditReport() {
        const s = new Date(document.getElementById('reportStartDate').value);
        const e = new Date(document.getElementById('reportEndDate').value); e.setHours(23,59,59);
        if(isNaN(s)||isNaN(e)) return alert("Select Dates");

        const fDist = distributions.filter(d=>{const x=new Date(d.date); return x>=s && x<=e});
        const fRest = restocks.filter(r=>{const x=new Date(r.date); return x>=s && x<=e});
        const fRet = returns.filter(r=>{const x=new Date(r.date); return x>=s && x<=e});

        const doc = new window.jspdf.jsPDF('l','mm','a4');
        doc.setFontSize(18); doc.text("Detailed Audit Report", 14, 15);
        doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);
        
        let y=30;
        doc.setFontSize(12); doc.setTextColor(0,0,255); doc.text("1. Current Stock Status", 14, y); y+=5;
        const stockTot = products.reduce((a,b)=>a+(b.buyPrice*b.stock),0);
        doc.autoTable({startY:y, head:[['ID','Name','Buy','Sell','Stock','Value']], body:[...products.map(p=>[p.id,p.name,p.buyPrice,p.sellPrice,p.stock,(p.buyPrice*p.stock).toFixed(2)]),['','','','','Total:',stockTot.toFixed(2)]]});
        y = doc.lastAutoTable.finalY + 10;

        doc.text("2. Sales Transactions", 14, y); y+=5;
        const saleTot = fDist.reduce((a,b)=>a+b.value,0);
        doc.autoTable({startY:y, head:[['Date','Item','Shop','Qty','Free','Value']], body:[...fDist.map(d=>[new Date(d.date).toLocaleDateString(),d.productName,d.shop,d.qty,d.freeQty,d.value.toFixed(2)]),['','','','','Total:',saleTot.toFixed(2)]]});
        y = doc.lastAutoTable.finalY + 10;

        doc.text("3. Returns (Deductions)", 14, y); y+=5;
        const retTot = fRet.reduce((a,b)=>a+b.value,0);
        doc.autoTable({startY:y, head:[['Date','Item','Shop','Reason','Stock Added?','Qty','Value']], body:[...fRet.map(r=>[new Date(r.date).toLocaleDateString(),r.productName,r.shop,r.reason,r.addedToStock?'Yes':'No',r.qty,r.value.toFixed(2)]),['','','','','','Total:',retTot.toFixed(2)]]});
        y = doc.lastAutoTable.finalY + 15;

        const expTot = fRest.reduce((a,b)=>a+b.cost,0);
        const finalNet = saleTot - expTot - retTot;
        doc.setFontSize(14); doc.setTextColor(0,0,0);
        doc.text(`Net Period Profit: Rs. ${finalNet.toFixed(2)}`, 14, y);

        doc.save("detailed_audit_report.pdf");
    }

    // Init
    const d = new Date(); document.getElementById('reportEndDate').valueAsDate = d;
    d.setDate(d.getDate()-30); document.getElementById('reportStartDate').valueAsDate = d;
    
    // Set Ledger Defaults (Current Month)
    initLedgerDates();

    updateDots();
    initializeDatabaseListeners();
</script>
</body>
</html>
